<!-- templates/investments/asset_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-900 to-black text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Back Button -->
        <a href="{% url 'core:assets' %}" class="inline-flex items-center text-blue-400 hover:text-blue-300 mb-6">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Market
        </a>
        
        <!-- Asset Header -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Column: Asset Info -->
            <div class="lg:w-2/3">
                <div class="bg-gray-800 rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-full 
                                {% if asset.category == 'crypto' %}bg-yellow-900/30
                                {% elif asset.category == 'forex' %}bg-blue-900/30
                                {% elif asset.category == 'futures' %}bg-purple-900/30
                                {% else %}bg-green-900/30{% endif %} 
                                flex items-center justify-center">
                                <span class="text-2xl font-bold">{{ asset.symbol|slice:":3" }}</span>
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold">{{ asset.name }}</h1>
                                <p class="text-gray-400">{{ asset.symbol }} â€¢ {{ asset.get_category_display }}</p>
                                <div class="flex items-center space-x-2 mt-2">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium
                                        {% if asset.risk_level == 'low' %}bg-green-900/50 text-green-300
                                        {% elif asset.risk_level == 'medium' %}bg-yellow-900/50 text-yellow-300
                                        {% elif asset.risk_level == 'high' %}bg-orange-900/50 text-orange-300
                                        {% else %}bg-red-900/50 text-red-300{% endif %}">
                                        {{ asset.get_risk_level_display }}
                                    </span>
                                    <span class="px-3 py-1 rounded-full bg-blue-900/50 text-blue-300 text-sm">
                                        Volatility: {{ asset.volatility|default:"Medium" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-bold">{{ currency_symbol }}{{ asset.display_price|floatformat:2 }}</div>
                            <div class="text-lg {% if asset.change_percentage >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                {% if asset.change_percentage >= 0 %}+{% endif %}{{ asset.change_percentage|floatformat:2 }}%
                            </div>
                            <div class="text-sm text-gray-400 mt-1">Last updated: {{ asset.last_updated|date:"H:i:s" }}</div>
                        </div>
                    </div>
                    
                    <!-- Asset Description -->
                    <div class="mt-6">
                        <h2 class="text-xl font-bold mb-3">About {{ asset.name }}</h2>
                        <p class="text-gray-300 leading-relaxed">
                            {{ asset.description|default:"No description available." }}
                        </p>
                    </div>
                </div>
                
                <!-- Investment Form -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6">Invest in {{ asset.name }}</h2>
                    
                    <!-- Balance Info -->
                    <div class="mb-6 p-4 bg-gray-900/50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-400">Available Balance</p>
                                <p class="text-2xl font-bold">{{ currency_symbol }}{{ wallet_balance|floatformat:2 }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-400">Minimum Investment</p>
                                <p class="text-xl font-semibold text-blue-400">{{ currency_symbol }}{{ asset.display_min_investment|floatformat:2 }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Investment Form -->
                    <form method="post" action="{% url 'investments:invest_asset' asset.id %}">
                        {% csrf_token %}
                        
                        <!-- Amount Input -->
                        <div class="mb-6">
                            <label class="block text-gray-300 mb-2 font-medium">Investment Amount</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">{{ currency_symbol }}</span>
                                <input type="number" 
                                       name="amount" 
                                       min="{{ asset.display_min_investment|floatformat:2 }}"
                                       max="{{ asset.display_max_investment|floatformat:2 }}"
                                       step="0.01"
                                       placeholder="Enter amount"
                                       class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       required>
                            </div>
                            <p class="text-sm text-gray-400 mt-2">
                                Range: {{ currency_symbol }}{{ asset.display_min_investment|floatformat:2 }} - 
                                {{ currency_symbol }}{{ asset.display_max_investment|floatformat:2 }}
                            </p>
                        </div>
                        
                        <!-- Duration Selection -->
                        <div class="mb-8">
                            <label class="block text-gray-300 mb-4 font-medium">Select Duration</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                {% for option in duration_options %}
                                    <label class="duration-option relative">
                                        <input type="radio" 
                                               name="duration_hours" 
                                               value="{{ option.hours }}"
                                               class="hidden peer"
                                               {% if option.hours == default_duration %}checked{% endif %}>
                                        <div class="cursor-pointer p-4 bg-gray-900 border-2 border-gray-700 rounded-xl transition-all duration-200 
                                                   peer-checked:border-blue-500 peer-checked:bg-blue-900/20 peer-checked:ring-1 peer-checked:ring-blue-500
                                                   hover:border-gray-500">
                                            <div class="text-center">
                                                <div class="text-lg font-bold text-white">{{ option.label }}</div>
                                                <div class="text-2xl font-bold text-green-400 mt-2">+{{ option.return_rate }}%</div>
                                                <div class="text-sm text-gray-300 mt-2">
                                                    Profit: {{ currency_symbol }}{{ option.example_profit.display|floatformat:2 }}
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Expected Return Summary -->
                        <div class="mb-6 p-4 bg-gradient-to-r from-emerald-900/30 to-teal-900/30 rounded-lg border border-emerald-700/50">
                            <h3 class="font-bold text-lg mb-2">Expected Return</h3>
                            <div id="return-summary" class="text-center">
                                <p class="text-gray-300">Select an amount and duration to see your expected return</p>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" 
                                class="w-full bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-700 hover:to-teal-600 
                                       text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-200 transform hover:scale-[1.02]">
                            Confirm Investment
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Right Column: Stats & Similar -->
            <div class="lg:w-1/3">
                <!-- Investment Stats -->
                <div class="bg-gray-800 rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Investment Statistics</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">24h Volume</span>
                            <span class="font-semibold">{{ currency_symbol }}{{ asset.volume_24h|default:"N/A" }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Market Cap</span>
                            <span class="font-semibold">{{ currency_symbol }}{{ asset.market_cap|default:"N/A" }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Avg. Return</span>
                            <span class="font-semibold text-green-400">{{ asset.average_return|default:"15" }}%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Success Rate</span>
                            <span class="font-semibold text-green-400">{{ asset.success_rate|default:"92" }}%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Chart -->
                <div class="bg-gray-800 rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">30-Day Performance</h2>
                    <div class="h-48">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                
                <!-- Similar Assets -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4">Similar Assets</h2>
                    <div class="space-y-3">
                        {% for similar in similar_assets %}
                            <a href="{% url 'investments:asset_detail' similar.id %}" 
                               class="flex items-center justify-between p-3 bg-gray-900/50 rounded-lg hover:bg-gray-700/50 transition">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                                        <span class="font-bold">{{ similar.symbol|slice:":2" }}</span>
                                    </div>
                                    <div>
                                        <p class="font-medium">{{ similar.name }}</p>
                                        <p class="text-sm text-gray-400">{{ similar.symbol }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold">{{ currency_symbol }}{{ similar.display_price|floatformat:2 }}</p>
                                    <p class="text-sm {% if similar.change_percentage >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                        {% if similar.change_percentage >= 0 %}+{% endif %}{{ similar.change_percentage|default:0|floatformat:1 }}%
                                    </p>
                                </div>
                            </a>
                        {% empty %}
                            <p class="text-gray-400 text-center py-4">No similar assets found</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic return calculation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const amountInput = document.querySelector('input[name="amount"]');
    const durationOptions = document.querySelectorAll('input[name="duration_hours"]');
    const returnSummary = document.getElementById('return-summary');
    const currencySymbol = '{{ currency_symbol|escapejs }}';
    
    // Duration data from template
    const durationData = {
        {% for option in duration_options %}
            {{ option.hours }}: {
                returnRate: {{ option.return_rate }},
                exampleProfit: {{ option.example_profit.display|floatformat:2 }}
            },
        {% endfor %}
    };
    
    function updateReturnSummary() {
        const amount = parseFloat(amountInput.value);
        const selectedDuration = document.querySelector('input[name="duration_hours"]:checked');
        
        if (!amount || !selectedDuration) return;
        
        const duration = parseInt(selectedDuration.value);
        const returnRate = durationData[duration].returnRate;
        const expectedProfit = (amount * returnRate) / 100;
        const totalReturn = amount + expectedProfit;
        
        returnSummary.innerHTML = `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span>Investment:</span>
                    <span class="font-bold">${currencySymbol}${amount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Duration:</span>
                    <span class="font-bold">${duration} hour${duration > 1 ? 's' : ''}</span>
                </div>
                <div class="flex justify-between">
                    <span>Return Rate:</span>
                    <span class="font-bold text-green-400">+${returnRate}%</span>
                </div>
                <div class="flex justify-between text-lg">
                    <span>Expected Profit:</span>
                    <span class="font-bold text-green-400">${currencySymbol}${expectedProfit.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-xl pt-2 border-t border-emerald-700/50">
                    <span>Total Return:</span>
                    <span class="font-bold text-white">${currencySymbol}${totalReturn.toFixed(2)}</span>
                </div>
            </div>
        `;
    }
    
    // Add event listeners
    amountInput.addEventListener('input', updateReturnSummary);
    durationOptions.forEach(option => {
        option.addEventListener('change', updateReturnSummary);
    });
    
    // Initialize chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chartData = {
        labels: [{% for item in performance_history %}"{{ item.date|date:'d M' }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Price',
            data: [{% for item in performance_history %}{{ item.price|floatformat:2 }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    };
    
    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#9CA3AF',
                        maxTicksLimit: 6
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#9CA3AF',
                        callback: function(value) {
                            return currencySymbol + value;
                        }
                    }
                }
            }
        }
    });
});
</script>

<style>
.duration-option input:checked + div {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}
</style>
{% endblock %}